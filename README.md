# DHNLNtupleAnalysis

`DHNLNtupleAnalysis` is a framework for reading ntuples generated by [DHNLAlgorithm](https://gitlab.cern.ch/atlas-phys/exot/ueh/EXOT-2017-19/DHNLAlgorithm) 
that was developed for the displaced heavy neutral lepton (DHNL) analysis. For installation instructions, see the "Getting Started" section below.

## Getting Started

To clone the project: 

```
setupATLAS
lsetup git
git clone ssh://git@gitlab.cern.ch:7999/atlas-phys/exot/ueh/EXOT-2017-19/DHNLNtupleAnalysis.git
```

The analysis code uses the package `uproot` to load root files. For more details see [uproot documentation](https://pypi.org/project/uproot/). To setup python to include the `uproot` package on lxplus do the following: 

```
source /cvmfs/sft.cern.ch/lcg/views/LCG_latest/x86_64-centos7-gcc9-opt/setup.sh
```

If you are running on a local cluster the complier version might change (i.e. gcc9 -> gcc8). Alternatively you can setup python and install the uproot package locally yourself. 

### Running makeHistograms.py

To make histograms from DHNL ntuples do the following: 
```
cd python 
python makeHistograms.py -i path_to_dHNLntuple --config ../data/config_mc_all.json
```
One root file per channel will be saved in DHNLNtupleAnalysis/output/ folder. 


If you only want to run on a single channel (e.g. uuu channel) then run: 
```
cd python 
python makeHistograms.py -i path_to_dHNLntuple --config ../data/config_mc_uuu.json
```
For this example, the code will save the file DHNLNtupleAnalysis/output/histograms_uuu.root. See a full list of channels see this [list](#list-of-configuration-files) below.


If you have previously created histograms files for the channel you are trying to run, you can run the following to overwrite the output file: 
```
python makeHistograms.py --force -i path_to_dHNLntuple --config ../data/config_mc_all.json
```
Without the `--force` option, the code will not run to prevent you from accidentally overwriting your histogram files!


### Running plotHistograms.py

Will update soon!!


## Quick Start Guide

This ntuple analysis code is designed to output histograms for analysis selection variables in the dHNL analysis. 

The `makeHistogram.py` file is the steering code for making histograms. To run the code, a configuration file is needed that provides the analysis code with a list of selections associated to a given channel name. For a list of the supported channel names see [List of configuration files](#list-of-configuration-files).

To add a new channel, edit the corresponding config file and make a new channel that includes the cuts you wish to apply. 

For example if you edit `../data/config_mc_all.json` and add "my_new_channel", when you run `makeHistograms.py -i inputFile --config ../data/config_mc_all.json`, a new histograms file will be created called `histograms_my_new_channel.root` in the output directory. This output file will include histograms with your new cuts. 

N.B If you wish to apply a new set of cuts that are not implemented you may wish to make a new analysis class. An example can be found in the comments at the end of `analysis.py`

For a list of the currently implemented cuts see the Analysis class definition in `analysis.py`.

To add new histograms, add a new observable to the list in `observables.py`. Then fill the histogram in the corresponding function in `analysis.py`.

To add a new selection, make a new class in `selections.py`.

## List of configuration files

The following are the default channels that have corresponding config files in DHNLNtupleAnalysis/data: 
- uuu: Prompt muon, 2-displaced muons
- ueu: Prompt muon, 1-displaced muon & 1-displaced electron 
- uee: Prompt muon, 2-displaced electrons
- euu: Prompt electron, 2-displaced muons
- eeu: Prompt electron, 1-displaced muon & 1-displaced electron 
- eee: Prompt electron, 2-displaced electrons



## Making Pretty Plots
<details><summary>This info is out of date. Don't follow this!</summary>
<p>

N.B This section is still under development and not currently accurate. Don't follow this!!!


A skeleton plotting code called `plotHistograms.py` is implemented to format plots from `histograms.root` output file. Currently you can save cutflows and compare 2 histograms contained in one histogram.root file. 

For making cutflow plots: 

1) open `plotHistogram.py`
2) edit the histos_savepath to the path where you want to save the plots
3) update the plot_cutflow() function with the channel name, vertexing configuration and the savefilename

For comparing two histograms: 
1) open `plotHistogram.py`
2) edit the histos_savepath to the path where you want to save the plots
3) update the compare2() function with name and legend label for each histogram, xlabel and savefilename

To run: 

```
python plotHistograms.py -f ../output/histograms.root
```

More functionality (e.g. ratio plots, compare3 histograms etc.) is planned to be added!

</p>
</details>





